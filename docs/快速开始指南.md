# VoxWorld çŠ¶æ€ä¸é¢†åŸŸå»ºæ¨¡ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒæ–‡æ¡£
- **[çŠ¶æ€ä¸é¢†åŸŸå»ºæ¨¡è®¾è®¡æ–¹æ¡ˆ.md](çŠ¶æ€ä¸é¢†åŸŸå»ºæ¨¡è®¾è®¡æ–¹æ¡ˆ.md)** - å®Œæ•´çš„æ¶æ„è®¾è®¡æ–‡æ¡£
  - ä¸‰å±‚çŠ¶æ€æ¨¡å‹ï¼ˆé€šç”¨ã€ä¸“ç”¨ã€æ´»è·ƒé›†åˆï¼‰
  - é¢†åŸŸæ¨¡å—åŒ–æ¶æ„
  - Reaction/Command ç³»ç»Ÿ
  - 8 ä¸ªå®æ–½é˜¶æ®µçš„è¯¦ç»†è§„åˆ’
  - 5 ç§ç©æ³•ç¤ºä¾‹

### 2. åŸºç¡€ä»£ç æ¡†æ¶

å·²åˆ›å»ºä»¥ä¸‹æ ¸å¿ƒæ¨¡å—ï¼š

#### [src/voxel/flags.rs](../src/voxel/flags.rs)
- `VoxelFlags` bitflags å®ç°ï¼ˆ16 ä½çŠ¶æ€æ ‡å¿—ï¼‰
- åŒ…å«ï¼šç‡ƒçƒ§ã€æ¸©åº¦ã€æ¹¿åº¦ã€ç»“æ„ã€ç”Ÿç‰©ç­‰ 15 ç§çŠ¶æ€
- å®Œæ•´çš„å•å…ƒæµ‹è¯•

#### [src/voxel/change.rs](../src/voxel/change.rs)
- `BlockChange` æšä¸¾ï¼ˆå˜æ›´è®°å½•ï¼‰
- æ”¯æŒ SetVoxelã€SetFlagã€SetVariantã€SetTempã€SetMoisture
- æä¾› `needs_remesh()` åˆ¤æ–­æ–¹æ³•

#### [src/voxel/domains/mod.rs](../src/voxel/domains/mod.rs)
- `SimulationSet` ç³»ç»Ÿé›†å®šä¹‰ï¼ˆ6 ä¸ªæ‰§è¡Œé˜¶æ®µï¼‰
- `DomainPlugin` æ’ä»¶ï¼ˆé…ç½®ç³»ç»Ÿé¡ºåºï¼‰
- å‘½ä»¤é˜Ÿåˆ—åˆå§‹åŒ–

#### [src/voxel/domains/command.rs](../src/voxel/domains/command.rs)
- `DomainCommand` æšä¸¾ï¼ˆ14 ç§å‘½ä»¤ç±»å‹ï¼‰
- `CommandQueue` ç»„ä»¶ï¼ˆå…¨å±€å‘½ä»¤é˜Ÿåˆ—ï¼‰
- `commit_system` ç³»ç»Ÿï¼ˆç»Ÿä¸€æäº¤é˜¶æ®µï¼‰

#### [src/voxel/domains/reaction.rs](../src/voxel/domains/reaction.rs)
- `ReactionRule` traitï¼ˆååº”è§„åˆ™æ¥å£ï¼‰
- `ReactionRules` èµ„æºï¼ˆè§„åˆ™æ³¨å†Œè¡¨ï¼‰

### 3. é¡¹ç›®é›†æˆ
- âœ… æ·»åŠ  `bitflags = "2.6"` ä¾èµ–
- âœ… æ›´æ–° [src/voxel/mod.rs](../src/voxel/mod.rs) å¯¼å‡ºæ–°æ¨¡å—
- âœ… ä»£ç ç¼–è¯‘é€šè¿‡ï¼ˆæ— é”™è¯¯ï¼Œä»…æœ‰æœªä½¿ç”¨å¯¼å…¥çš„è­¦å‘Šï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### Phase 1: æ‰©å±• ChunkDataï¼ˆå»ºè®® 1-2 å¤©ï¼‰

#### 1.1 ä¿®æ”¹ [src/voxel/chunk.rs](../src/voxel/chunk.rs)

åœ¨ `ChunkData` ç»“æ„ä¸­æ·»åŠ æ–°å­—æ®µï¼š

```rust
use crate::voxel::flags::VoxelFlags;
use crate::voxel::change::BlockChange;
use std::collections::HashSet;

pub struct ChunkData {
    // === ç°æœ‰å­—æ®µ ===
    pub voxels: Vec<VoxelKind>,
    pub is_dirty: bool,

    // === æ–°å¢ï¼šé€šç”¨çŠ¶æ€ ===
    pub flags: Vec<VoxelFlags>,      // 4096 ä¸ªå…ƒç´ ï¼ˆæ¯ä¸ª 2 å­—èŠ‚ï¼‰
    pub variant: Vec<u8>,            // 4096 ä¸ªå…ƒç´ ï¼ˆæ¯ä¸ª 1 å­—èŠ‚ï¼‰

    // === æ–°å¢ï¼šæ´»è·ƒé›†åˆ ===
    pub active_thermal: HashSet<usize>,
    pub active_burning: HashSet<usize>,
    pub active_freezing: HashSet<usize>,

    // === æ–°å¢ï¼šå˜æ›´è®°å½• ===
    pub dirty_blocks: Vec<usize>,
    pub needs_remesh: bool,
    pub changes: Vec<BlockChange>,

    // === ä¸“ç”¨çŠ¶æ€ï¼ˆå…ˆä¸åŠ ï¼ŒPhase 2 å†åŠ ï¼‰===
    // pub thermal_state: Option<ThermalState>,
    // pub moisture_state: Option<MoistureState>,
    // pub combustion_state: Option<CombustionState>,
}

impl ChunkData {
    pub fn new(voxels: Vec<VoxelKind>) -> Self {
        let size = voxels.len();
        Self {
            voxels,
            is_dirty: false,
            // åˆå§‹åŒ–æ‰€æœ‰æ–¹å—ä¸º NONE æ ‡å¿—ä½
            flags: vec![VoxelFlags::NONE; size],
            variant: vec![0; size],
            active_thermal: HashSet::new(),
            active_burning: HashSet::new(),
            active_freezing: HashSet::new(),
            dirty_blocks: Vec::new(),
            needs_remesh: false,
            changes: Vec::new(),
        }
    }

    // è¾…åŠ©æ–¹æ³•ï¼šæ¸…ç†æœ¬å¸§çš„å˜æ›´è®°å½•
    pub fn clear_changes(&mut self) {
        self.dirty_blocks.clear();
        self.changes.clear();
        self.needs_remesh = false;
    }
}
```

#### 1.2 æ›´æ–°ç°æœ‰ä»£ç 

æœç´¢æ‰€æœ‰ `ChunkData::new()` æˆ– `ChunkData { voxels, is_dirty }` çš„åˆ›å»ºä»£ç ï¼Œç¡®ä¿å…¼å®¹æ–°ç»“æ„ã€‚

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æœç´¢ï¼š
```bash
rg "ChunkData \{" --type rust
rg "ChunkData::new" --type rust
```

#### 1.3 æµ‹è¯•åŸºç¡€åŠŸèƒ½

åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–‡ä»¶ï¼š

```rust
// tests/chunk_state_test.rs

#[cfg(test)]
mod tests {
    use voxworld::voxel::*;

    #[test]
    fn test_chunk_flags() {
        let voxels = vec![VoxelKind::OakLog; CHUNK_SIZE * CHUNK_SIZE * CHUNK_SIZE];
        let mut chunk = ChunkData::new(voxels);

        // è®¾ç½®ç‡ƒçƒ§æ ‡å¿—
        chunk.flags[0].insert(VoxelFlags::BURNING);
        assert!(chunk.flags[0].contains(VoxelFlags::BURNING));

        // è®°å½•å˜æ›´
        chunk.changes.push(BlockChange::SetFlag {
            idx: 0,
            flag: VoxelFlags::BURNING,
            set: true,
        });

        assert_eq!(chunk.changes.len(), 1);
    }

    #[test]
    fn test_active_sets() {
        let voxels = vec![VoxelKind::Air; CHUNK_SIZE * CHUNK_SIZE * CHUNK_SIZE];
        let mut chunk = ChunkData::new(voxels);

        // æ¿€æ´»æ–¹å—
        chunk.active_burning.insert(42);
        chunk.active_burning.insert(100);

        assert_eq!(chunk.active_burning.len(), 2);
        assert!(chunk.active_burning.contains(&42));
    }
}
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
cargo test
```

---

### Phase 2: æ‰©å±• VoxelPropertiesï¼ˆå»ºè®® 2-3 å¤©ï¼‰

#### 2.1 ä¿®æ”¹ [src/voxel/voxel_kind.rs](../src/voxel/voxel_kind.rs)

å‚è€ƒè®¾è®¡æ–¹æ¡ˆä¸­çš„ `VoxelProperties` å®šä¹‰ï¼Œæ·»åŠ å®Œæ•´çš„ç‰©ç†å±æ€§ï¼š

```rust
#[derive(Clone, Debug)]
pub struct VoxelProperties {
    // === çƒ­å­¦å±æ€§ ===
    pub temperature: f32,
    pub heat_capacity: f32,
    pub thermal_conductivity: f32,
    pub env_exchange_coef: f32,

    // === æ¹¿åº¦å±æ€§ ===
    pub humidity: f32,
    pub moisture_capacity: f32,
    pub evaporation_rate: f32,

    // === ç‡ƒçƒ§å±æ€§ ===
    pub is_flammable: bool,
    pub ignition_temp: f32,
    pub burn_energy: f32,
    pub burn_rate: f32,
    pub heat_release: f32,
    pub char_block: Option<VoxelKind>,
    pub ash_block: Option<VoxelKind>,

    // === ç›¸å˜å±æ€§ ===
    pub melting_point: Option<f32>,
    pub freezing_point: Option<f32>,
    pub liquid_form: Option<VoxelKind>,
    pub solid_form: Option<VoxelKind>,

    // === ç»“æ„å±æ€§ ===
    pub hardness: f32,
    pub ductility: f32,
    pub integrity: f32,
    pub corrosion_resistance: f32,

    // === ç”Ÿé•¿å±æ€§ ===
    pub is_growable: bool,
    pub growth_rate: f32,
    pub max_growth_stage: u8,
}

impl Default for VoxelProperties {
    fn default() -> Self {
        Self {
            temperature: 20.0,
            heat_capacity: 1000.0,
            thermal_conductivity: 0.1,
            env_exchange_coef: 0.01,
            humidity: 0.5,
            moisture_capacity: 0.5,
            evaporation_rate: 0.1,
            is_flammable: false,
            ignition_temp: 1000.0,
            burn_energy: 0.0,
            burn_rate: 0.0,
            heat_release: 0.0,
            char_block: None,
            ash_block: None,
            melting_point: None,
            freezing_point: None,
            liquid_form: None,
            solid_form: None,
            hardness: 1.0,
            ductility: 0.0,
            integrity: 1.0,
            corrosion_resistance: 1.0,
            is_growable: false,
            growth_rate: 0.0,
            max_growth_stage: 0,
        }
    }
}
```

#### 2.2 ä¸ºç°æœ‰ 33 ç§æ–¹å—å®šä¹‰å±æ€§

ä¼˜å…ˆå®šä¹‰å¸¸ç”¨æ–¹å—ï¼š

**ç¤ºä¾‹ 1: OakLogï¼ˆå¯ç‡ƒï¼‰**
```rust
VoxelKind::OakLog => VoxelProperties {
    temperature: 20.0,
    heat_capacity: 1700.0,
    thermal_conductivity: 0.12,
    is_flammable: true,
    ignition_temp: 300.0,
    burn_energy: 100.0,
    burn_rate: 0.2,
    heat_release: 200.0,
    // char_block: Some(VoxelKind::CharredOakLog),  // éœ€è¦æ·»åŠ æ–°æ–¹å—ç±»å‹
    hardness: 2.0,
    corrosion_resistance: 0.3,
    ..Default::default()
},
```

**ç¤ºä¾‹ 2: Waterï¼ˆç›¸å˜ï¼‰**
```rust
VoxelKind::Water => VoxelProperties {
    temperature: 15.0,
    heat_capacity: 4186.0,
    thermal_conductivity: 0.6,
    humidity: 1.0,
    freezing_point: Some(0.0),
    solid_form: Some(VoxelKind::Ice),
    hardness: 0.0,
    ..Default::default()
},
```

**ç¤ºä¾‹ 3: Iceï¼ˆç›¸å˜ï¼‰**
```rust
VoxelKind::Ice => VoxelProperties {
    temperature: -5.0,
    heat_capacity: 2090.0,
    thermal_conductivity: 2.22,
    melting_point: Some(0.0),
    liquid_form: Some(VoxelKind::Water),
    hardness: 0.5,
    ..Default::default()
},
```

---

### Phase 3: å®ç°ç¬¬ä¸€ä¸ªç©æ³•ï¼ˆç‡ƒçƒ§ç³»ç»Ÿï¼‰ï¼ˆå»ºè®® 3-4 å¤©ï¼‰

#### 3.1 æ·»åŠ æ–°æ–¹å—ç±»å‹

åœ¨ [src/voxel/voxel_kind.rs](../src/voxel/voxel_kind.rs) ä¸­æ·»åŠ ï¼š

```rust
pub enum VoxelKind {
    // ... ç°æœ‰ 33 ç§ ...

    // ç‡ƒçƒ§ç›¸å…³æ–°æ–¹å—
    CharredOakLog,    // ç„¦åŒ–æ©¡æœ¨
    CharredBirchLog,  // ç„¦åŒ–ç™½æ¡¦æœ¨
    CharredSpruceLog, // ç„¦åŒ–äº‘æ‰æœ¨
    Ash,              // ç°çƒ¬
}
```

#### 3.2 åˆ›å»ºç‡ƒçƒ§é¢†åŸŸæ¨¡å—

åˆ›å»º `src/voxel/domains/combustion/` ç›®å½•ç»“æ„ï¼š

```rust
// src/voxel/domains/combustion/mod.rs
pub mod state;
pub mod api;
pub mod systems;
pub mod plugin;

pub use state::*;
pub use api::*;
pub use plugin::CombustionPlugin;
```

#### 3.3 å®ç°ç©å®¶ç‚¹ç«è¾“å…¥

```rust
// src/player.rs æˆ–æ–°æ–‡ä»¶ src/voxel/domains/combustion/input.rs

use bevy::prelude::*;
use crate::voxel::domains::command::*;
use crate::raycast::HighlightState;

pub fn player_ignite_input(
    keyboard: Res<ButtonInput<KeyCode>>,
    raycast: Res<HighlightState>,
    mut command_queues: Query<&mut CommandQueue>,
) {
    if keyboard.just_pressed(KeyCode::KeyF) {
        if let Some(hit) = &raycast.current {
            if let Some(mut queue) = command_queues.iter_mut().next() {
                let idx = calculate_block_index(hit.pos); // éœ€è¦å®ç°åæ ‡è½¬ç´¢å¼•
                queue.commands.push(DomainCommand::Ignite {
                    idx,
                    power: 1.0,
                });
                info!("Igniting block at {:?}", hit.pos);
            }
        }
    }
}
```

#### 3.4 æµ‹è¯•ç‡ƒçƒ§æµç¨‹

1. æŒ‰ `F` é”®ç‚¹ç‡ƒæ–¹å—
2. è§‚å¯Ÿ `commit_system` çš„æ—¥å¿—è¾“å‡º
3. éªŒè¯ `flags[idx]` åŒ…å« `BURNING`
4. æŸ¥çœ‹ `active_burning` é›†åˆ

---

## ğŸ“š å­¦ä¹ è·¯å¾„

### ç¬¬ 1 å‘¨ï¼šåŸºç¡€çŠ¶æ€ç³»ç»Ÿ
- [ ] å®Œæˆ ChunkData æ‰©å±•
- [ ] å®Œæˆ VoxelProperties æ‰©å±•
- [ ] ä¸º 10 ä¸ªå¸¸ç”¨æ–¹å—å®šä¹‰å±æ€§
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

### ç¬¬ 2 å‘¨ï¼šç¬¬ä¸€ä¸ªé¢†åŸŸï¼ˆç‡ƒçƒ§ï¼‰
- [ ] å®ç° CombustionState
- [ ] å®ç° CombustionApiï¼ˆignite/extinguishï¼‰
- [ ] å®ç°ç©å®¶ç‚¹ç«è¾“å…¥
- [ ] å®ç°ç®€å•çš„ç‡ƒçƒ§ tickï¼ˆæ¶ˆè€—ç‡ƒæ–™ï¼‰

### ç¬¬ 3 å‘¨ï¼šçƒ­åŠ›å­¦é¢†åŸŸ
- [ ] å®ç° ThermalState
- [ ] å®ç° ThermalApi
- [ ] å®ç°çƒ­æ‰©æ•£ç³»ç»Ÿ
- [ ] é›†æˆç‡ƒçƒ§+çƒ­åŠ›å­¦ï¼ˆç‡ƒçƒ§é‡Šæ”¾çƒ­é‡ï¼‰

### ç¬¬ 4 å‘¨ï¼šç¬¬ä¸€ä¸ªååº”è§„åˆ™
- [ ] å®ç° ThermalIgnitionRuleï¼ˆæ¸©åº¦ç‚¹ç‡ƒï¼‰
- [ ] é›†æˆåˆ° reaction_emit_system
- [ ] æµ‹è¯•ï¼šç«æºâ†’åŠ çƒ­â†’è‡ªåŠ¨ç‚¹ç‡ƒ

---

## ğŸ¯ é‡Œç¨‹ç¢‘ç›®æ ‡

### Milestone 1: å¯ç‚¹ç‡ƒçš„æœ¨å¤´
- ç©å®¶å¯ä»¥æŒ‰ F é”®ç‚¹ç‡ƒæ–¹å—
- æœ¨å¤´è¢«ç‚¹ç‡ƒåæ˜¾ç¤º BURNING æ ‡å¿—
- æ§åˆ¶å°è¾“å‡ºç‡ƒçƒ§æ—¥å¿—

### Milestone 2: ç‡ƒçƒ§ä¼ æ’­
- ç‡ƒçƒ§çš„æ–¹å—å‘å‘¨å›´é‡Šæ”¾çƒ­é‡
- ç›¸é‚»çš„å¯ç‡ƒæ–¹å—æ¸©åº¦å‡é«˜
- æ¸©åº¦è¶…è¿‡ç€ç«ç‚¹è‡ªåŠ¨ç‚¹ç‡ƒ

### Milestone 3: ç‡ƒå°½æ•ˆæœ
- ç‡ƒçƒ§æ¶ˆè€—ç‡ƒæ–™
- ç‡ƒæ–™è€—å°½åå˜æˆç„¦ç‚­
- ç„¦ç‚­ç»§ç»­ç‡ƒçƒ§åå˜æˆç°çƒ¬

### Milestone 4: å¯è§†åŒ–æ•ˆæœ
- ç‡ƒçƒ§æ–¹å—äº§ç”Ÿç«ç„°ç²’å­
- ç„¦åŒ–æ–¹å—é¢œè‰²å˜é»‘
- é«˜æ¸©æ–¹å—å‘å…‰

---

## ğŸ›  å¼€å‘å·¥å…·

### æœ‰ç”¨çš„å‘½ä»¤

```bash
# å¿«é€Ÿç¼–è¯‘æ£€æŸ¥
cargo check

# è¿è¡Œæµ‹è¯•
cargo test

# è¿è¡Œæ¸¸æˆ
cargo run

# æœç´¢ä»£ç 
rg "ChunkData" --type rust        # æœç´¢ ChunkData
rg "TODO" --type rust              # æœç´¢ TODO æ ‡è®°

# æ ¼å¼åŒ–ä»£ç 
cargo fmt

# ä»£ç è´¨é‡æ£€æŸ¥
cargo clippy
```

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨æ—¥å¿—**
   - åœ¨ `main.rs` ä¸­æ·»åŠ ï¼š`LogPlugin::default()`
   - ä½¿ç”¨ `info!()`, `debug!()`, `warn!()` æ‰“å°æ—¥å¿—

2. **å¯è§†åŒ–è°ƒè¯•**
   - æŒ‰ F3 æ‰“å¼€è°ƒè¯•è¦†ç›–å±‚
   - æ˜¾ç¤ºæ´»è·ƒé›†åˆå¤§å°
   - æ˜¾ç¤ºå‘½ä»¤é˜Ÿåˆ—é•¿åº¦

3. **å•å…ƒæµ‹è¯•**
   - ä¸ºæ¯ä¸ª API ç¼–å†™å•å…ƒæµ‹è¯•
   - æµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ

---

## ğŸ“– å‚è€ƒèµ„æ–™

- **è®¾è®¡çº²é¢†**: [bevy_ä½“ç´ _mmoï¼šchunk_åŸŸæ¨¡æ‹Ÿä¸æ¨¡å—åŒ–è®¾è®¡çº²é¢†.md](bevy_ä½“ç´ _mmoï¼šchunk_åŸŸæ¨¡æ‹Ÿä¸æ¨¡å—åŒ–è®¾è®¡çº²é¢†.md)
- **è¯¦ç»†è®¾è®¡**: [çŠ¶æ€ä¸é¢†åŸŸå»ºæ¨¡è®¾è®¡æ–¹æ¡ˆ.md](çŠ¶æ€ä¸é¢†åŸŸå»ºæ¨¡è®¾è®¡æ–¹æ¡ˆ.md)
- **Bevy æ–‡æ¡£**: https://bevyengine.org/learn/
- **ECS æ¨¡å¼**: https://en.wikipedia.org/wiki/Entity_component_system

---

## â“ å¸¸è§é—®é¢˜

### Q: æ´»è·ƒé›†åˆä¼šä¸ä¼šæ— é™å¢é•¿ï¼Ÿ

A: ä¸ä¼šï¼Œç³»ç»Ÿä¼šå®šæœŸæ£€æŸ¥æ–¹å—çŠ¶æ€ï¼Œå¦‚æœæ¸©åº¦å›åˆ°é»˜è®¤å€¼ã€ç‡ƒçƒ§ç»“æŸç­‰ï¼Œä¼šè‡ªåŠ¨ä»æ´»è·ƒé›†åˆç§»é™¤ã€‚

### Q: è·¨ Chunk è¾¹ç•Œæ€ä¹ˆå¤„ç†ï¼Ÿ

A: Phase 1-3 å…ˆä¸è€ƒè™‘è·¨ Chunkï¼Œåªåœ¨å•ä¸ª Chunk å†…æµ‹è¯•ã€‚Phase 7 ä¼šä¸“é—¨å¤„ç†è¾¹ç•Œé—®é¢˜ã€‚

### Q: æ€§èƒ½ä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ

A: æ´»è·ƒé›†åˆé©±åŠ¨çš„è®¾è®¡å°±æ˜¯ä¸ºäº†æ€§èƒ½ï¼Œåªè®¡ç®—å˜åŒ–çš„æ–¹å—ã€‚åˆæœŸå¯ä»¥å…ˆä¸ä¼˜åŒ–ï¼ŒåŠŸèƒ½è·‘é€šåå†ç”¨ profiler åˆ†æç“¶é¢ˆã€‚

### Q: å¦‚ä½•æ·»åŠ æ–°çš„é¢†åŸŸçº¿ï¼Ÿ

A: ä¸¥æ ¼æŒ‰ç…§ Domain æ¨¡æ¿ï¼šState + API + Systems + Pluginï¼Œå‚è€ƒç‡ƒçƒ§é¢†åŸŸçš„å®ç°ã€‚

---

**ç¥ä½ å¼€å‘é¡ºåˆ©ï¼å¦‚æœ‰é—®é¢˜ï¼Œéšæ—¶æŸ¥é˜…è®¾è®¡æ–‡æ¡£æˆ–æé—®ã€‚** ğŸš€
